# Agent Framework Services for the Platform
# Usage: docker compose -f docker-compose.yml -f docker-compose.agents.yml up -d
#
# Provides multi-framework agent support:
# - CrewAI: Role-based agent teams
# - AutoGen: Multi-agent conversations
# - Agent Router: Unified API for all frameworks
#
# Existing services (Langflow, n8n) are configured elsewhere

services:
  # ==========================================================================
  # CrewAI Service - Role-based Agent Teams
  # ==========================================================================
  crewai:
    profiles: ["agents", "full"]
    build:
      context: ./services/agents/crewai
      dockerfile: Dockerfile
    container_name: ${CONTAINER_PREFIX:-engine}-crewai
    environment:
      - REDIS_URL=redis://${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/0
      - OLLAMA_BASE_URL=http://${OLLAMA_HOST:-ollama}:${OLLAMA_PORT:-11434}
      - AGENT_ROUTER_URL=http://${AGENT_ROUTER_HOST:-agent-router}:${AGENT_ROUTER_PORT:-8102}
    ports:
      - "8100:8100"
    depends_on:
      redis:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8100/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - engine-network
    restart: unless-stopped

  # ==========================================================================
  # AutoGen Service - Multi-Agent Conversations
  # ==========================================================================
  autogen:
    profiles: ["agents", "full"]
    build:
      context: ./services/agents/autogen
      dockerfile: Dockerfile
    container_name: ${CONTAINER_PREFIX:-engine}-autogen
    environment:
      - REDIS_URL=redis://${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/0
      - OLLAMA_BASE_URL=http://${OLLAMA_HOST:-ollama}:${OLLAMA_PORT:-11434}
      - AGENT_ROUTER_URL=http://${AGENT_ROUTER_HOST:-agent-router}:${AGENT_ROUTER_PORT:-8102}
    ports:
      - "8101:8101"
    depends_on:
      redis:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8101/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - engine-network
    restart: unless-stopped

  # ==========================================================================
  # Agent Router - Unified Agent API
  # Routes requests to CrewAI, AutoGen, Langflow, n8n
  # ==========================================================================
  agent-router:
    profiles: ["agents", "full"]
    build:
      context: ./services/agents/router
      dockerfile: Dockerfile
    container_name: ${CONTAINER_PREFIX:-engine}-agent-router
    environment:
      - REDIS_URL=redis://${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/0
      - CREWAI_URL=http://${CREWAI_HOST:-crewai}:8100
      - AUTOGEN_URL=http://${AUTOGEN_HOST:-autogen}:8101
      - LANGFLOW_URL=http://${LANGFLOW_HOST:-langflow}:7860
      - N8N_URL=http://${N8N_HOST:-n8n}:5678
      - AIML_DB_URL=postgresql://${AIML_POSTGRES_USER:-aiml_user}:${AIML_POSTGRES_PASSWORD:-aiml_dev_password}@${AIML_POSTGRES_HOST:-aiml-postgres}:${AIML_POSTGRES_PORT:-5432}/${AIML_POSTGRES_DB:-aiml}
    ports:
      - "8102:8102"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8102/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - engine-network
    restart: unless-stopped
