# ES1 Platform - Build Release Images (Smart)
#
# Builds only CHANGED custom images and retags unchanged ones from the previous
# release. Pre-built images are mirrored with `crane copy` to preserve multi-arch
# manifests (fixes ollama bug where docker pull/tag/push strips platform metadata).
#
# Trigger: Push of version tag (v*)
#
# Result:
#   27 images available in ghcr.io/[org]/es1-platform/
#
# Job graph:
#   setup (detect version + diff against previous tag)
#     ├── build-changed-images   (only custom images with source changes)
#     ├── retag-unchanged-images (crane tag unchanged custom images)
#     ├── mirror-prebuilt-images (crane copy from upstream OR crane tag from previous)
#     └── create-manifest + summary

name: Build Release Images

on:
  push:
    tags:
      - 'v*'

  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to build (e.g., v2.1.0)'
        required: true
        type: string
      force_full_build:
        description: 'Force rebuild of ALL images (ignore change detection)'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ vars.IMAGE_PREFIX || format('{0}/es1-platform', github.repository_owner) }}

jobs:
  # ===========================================================================
  # Setup — detect version, previous tag, and which images changed
  # ===========================================================================
  setup:
    name: Setup & Detect Changes
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      registry_prefix: ${{ steps.version.outputs.registry_prefix }}
      prev_version: ${{ steps.detect.outputs.prev_version }}
      has_changed: ${{ steps.detect.outputs.has_changed }}
      has_unchanged: ${{ steps.detect.outputs.has_unchanged }}
      changed_custom_matrix: ${{ steps.detect.outputs.changed_custom_matrix }}
      unchanged_custom_matrix: ${{ steps.detect.outputs.unchanged_custom_matrix }}
      workflow_changed: ${{ steps.detect.outputs.workflow_changed }}
      force_full_build: ${{ steps.detect.outputs.force_full_build }}
    steps:
      - name: Checkout (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "registry_prefix=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}" >> $GITHUB_OUTPUT

      - name: Detect changes since previous tag
        id: detect
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FORCE="${{ inputs.force_full_build }}"

          # Find previous tag (skip current version)
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${VERSION}$" | head -1)
          echo "Current version: $VERSION"
          echo "Previous tag: $PREV_TAG"
          echo "prev_version=$PREV_TAG" >> $GITHUB_OUTPUT

          # Force full build if requested or no previous tag exists
          if [[ "$FORCE" == "true" || -z "$PREV_TAG" ]]; then
            echo "force_full_build=true" >> $GITHUB_OUTPUT
            echo "Force full build: true (force=$FORCE, prev_tag=$PREV_TAG)"
          else
            echo "force_full_build=false" >> $GITHUB_OUTPUT
          fi

          # Check if this workflow file itself changed
          WORKFLOW_CHANGED="false"
          if [[ -n "$PREV_TAG" ]]; then
            if git diff --name-only "$PREV_TAG..HEAD" -- .github/workflows/build-release-images.yml | grep -q .; then
              WORKFLOW_CHANGED="true"
            fi
          fi
          echo "workflow_changed=$WORKFLOW_CHANGED" >> $GITHUB_OUTPUT

          # Define all 13 custom images and their build contexts
          declare -A CONTEXTS=(
            ["postgres"]="infrastructure/postgres"
            ["redis"]="infrastructure/redis"
            ["krakend"]="services/krakend"
            ["aiml-postgres"]="infrastructure/aiml-postgres"
            ["mlflow"]="infrastructure/mlflow"
            ["crewai"]="services/agents/crewai"
            ["autogen"]="services/agents/autogen"
            ["crewai-studio"]="services/agents/crewai-studio"
            ["autogen-studio"]="services/agents/autogen-studio"
            ["db-migrate"]="infrastructure/db-migrate"
            ["agent-router"]="services/agents/router"
            ["platform-manager-api"]="services/es1-platform-manager/api"
            ["platform-manager-ui"]="services/es1-platform-manager/ui"
          )

          CHANGED_JSON="[]"
          UNCHANGED_JSON="[]"

          if [[ "$FORCE" == "true" || -z "$PREV_TAG" ]]; then
            # Force: everything goes to changed
            for SERVICE in "${!CONTEXTS[@]}"; do
              CONTEXT="${CONTEXTS[$SERVICE]}"
              CHANGED_JSON=$(echo "$CHANGED_JSON" | jq -c ". + [{\"service\": \"$SERVICE\", \"context\": \"$CONTEXT\"}]")
            done
          else
            # Diff-based detection
            for SERVICE in "${!CONTEXTS[@]}"; do
              CONTEXT="${CONTEXTS[$SERVICE]}"
              DIFF_COUNT=$(git diff --name-only "$PREV_TAG..HEAD" -- "$CONTEXT" | wc -l | tr -d ' ')
              if [[ "$DIFF_COUNT" -gt 0 ]]; then
                echo "  CHANGED: $SERVICE ($DIFF_COUNT files in $CONTEXT)"
                CHANGED_JSON=$(echo "$CHANGED_JSON" | jq -c ". + [{\"service\": \"$SERVICE\", \"context\": \"$CONTEXT\"}]")
              else
                echo "  unchanged: $SERVICE"
                UNCHANGED_JSON=$(echo "$UNCHANGED_JSON" | jq -c ". + [{\"service\": \"$SERVICE\"}]")
              fi
            done
          fi

          CHANGED_COUNT=$(echo "$CHANGED_JSON" | jq length)
          UNCHANGED_COUNT=$(echo "$UNCHANGED_JSON" | jq length)

          echo "Changed custom images: $CHANGED_COUNT"
          echo "Unchanged custom images: $UNCHANGED_COUNT"

          # Build matrix objects
          CHANGED_MATRIX="{\"include\":$CHANGED_JSON}"
          UNCHANGED_MATRIX="{\"include\":$UNCHANGED_JSON}"

          echo "changed_custom_matrix=$CHANGED_MATRIX" >> $GITHUB_OUTPUT
          echo "unchanged_custom_matrix=$UNCHANGED_MATRIX" >> $GITHUB_OUTPUT

          if [[ "$CHANGED_COUNT" -gt 0 ]]; then
            echo "has_changed=true" >> $GITHUB_OUTPUT
          else
            echo "has_changed=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$UNCHANGED_COUNT" -gt 0 ]]; then
            echo "has_unchanged=true" >> $GITHUB_OUTPUT
          else
            echo "has_unchanged=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Tag | ${{ steps.detect.outputs.prev_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | ${{ steps.version.outputs.registry_prefix }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | linux/amd64 |" >> $GITHUB_STEP_SUMMARY
          echo "| Force Full Build | ${{ steps.detect.outputs.force_full_build }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Changed | ${{ steps.detect.outputs.workflow_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changed Custom Images | ${{ steps.detect.outputs.has_changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unchanged Custom Images | ${{ steps.detect.outputs.has_unchanged }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Build only custom images whose source changed
  # ===========================================================================
  build-changed-images:
    name: Build ${{ matrix.service }}
    needs: setup
    if: needs.setup.outputs.has_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.changed_custom_matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.context }}/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ needs.setup.outputs.registry_prefix }}/${{ matrix.service }}:${{ needs.setup.outputs.version }}
            ${{ needs.setup.outputs.registry_prefix }}/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.setup.outputs.version }}

  # ===========================================================================
  # Retag unchanged custom images from previous version (sub-second, no download)
  # ===========================================================================
  retag-unchanged-images:
    name: Retag ${{ matrix.service }}
    needs: setup
    if: needs.setup.outputs.has_unchanged == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.unchanged_custom_matrix) }}
    steps:
      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Retag from previous version
        run: |
          REGISTRY_PREFIX="${{ needs.setup.outputs.registry_prefix }}"
          SERVICE="${{ matrix.service }}"
          PREV="${{ needs.setup.outputs.prev_version }}"
          VERSION="${{ needs.setup.outputs.version }}"

          echo "Retagging ${SERVICE}: ${PREV} → ${VERSION}"
          crane tag "${REGISTRY_PREFIX}/${SERVICE}:${PREV}" "${VERSION}"
          crane tag "${REGISTRY_PREFIX}/${SERVICE}:${PREV}" "latest"

  # ===========================================================================
  # Mirror pre-built (upstream) images using crane copy
  # ===========================================================================
  mirror-prebuilt-images:
    name: Mirror ${{ matrix.service }}
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: ollama
            source: ollama/ollama:latest
          - service: ollama-webui
            source: ghcr.io/open-webui/open-webui:main
          - service: airflow
            source: apache/airflow:2.8.1-python3.11
          - service: statsd-exporter
            source: prom/statsd-exporter:v0.26.0
          - service: langflow
            source: langflowai/langflow:latest
          - service: langfuse
            source: langfuse/langfuse:2
          - service: n8n
            source: n8nio/n8n:latest
          - service: prometheus
            source: prom/prometheus:v2.51.0
          - service: grafana
            source: grafana/grafana:10.4.0
          - service: cadvisor
            source: gcr.io/cadvisor/cadvisor:v0.49.1
          - service: node-exporter
            source: prom/node-exporter:v1.7.0
          - service: postgres-exporter
            source: prometheuscommunity/postgres-exporter:v0.15.0
          - service: redis-exporter
            source: oliver006/redis_exporter:v1.58.0
          - service: kube-state-metrics
            source: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.12.0
    steps:
      - name: Install crane
        uses: imjasonh/setup-crane@v0.4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | crane auth login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Copy or retag pre-built image
        run: |
          REGISTRY_PREFIX="${{ needs.setup.outputs.registry_prefix }}"
          SERVICE="${{ matrix.service }}"
          SOURCE="${{ matrix.source }}"
          PREV="${{ needs.setup.outputs.prev_version }}"
          VERSION="${{ needs.setup.outputs.version }}"
          WORKFLOW_CHANGED="${{ needs.setup.outputs.workflow_changed }}"
          FORCE="${{ needs.setup.outputs.force_full_build }}"

          TARGET="${REGISTRY_PREFIX}/${SERVICE}:${VERSION}"
          TARGET_LATEST="${REGISTRY_PREFIX}/${SERVICE}:latest"

          # If workflow didn't change and previous tag exists, just retag from previous version
          # (upstream sources haven't changed in our matrix, so the image is identical)
          if [[ "$WORKFLOW_CHANGED" == "false" && "$FORCE" != "true" && -n "$PREV" ]]; then
            echo "Retagging ${SERVICE} from ${PREV} (workflow unchanged, skipping upstream pull)"
            crane tag "${REGISTRY_PREFIX}/${SERVICE}:${PREV}" "${VERSION}"
            crane tag "${REGISTRY_PREFIX}/${SERVICE}:${PREV}" "latest"
          else
            echo "Copying ${SOURCE} → ${TARGET} (platform: linux/amd64)"
            crane copy --platform linux/amd64 "${SOURCE}" "${TARGET}"
            crane copy --platform linux/amd64 "${SOURCE}" "${TARGET_LATEST}"
          fi

  # ===========================================================================
  # Create image manifest
  # ===========================================================================
  create-manifest:
    name: Create Image Manifest
    needs: [setup, build-changed-images, retag-unchanged-images, mirror-prebuilt-images]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate manifest
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          REGISTRY_PREFIX="${{ needs.setup.outputs.registry_prefix }}"

          mkdir -p .github/image-manifests

          cat > ".github/image-manifests/${VERSION}.txt" << EOF
          # ES1 Platform Image Manifest
          # Version: ${VERSION}
          # Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          # Registry: ${REGISTRY_PREFIX}
          #
          # Custom-built images (13):
          ${REGISTRY_PREFIX}/postgres:${VERSION}
          ${REGISTRY_PREFIX}/redis:${VERSION}
          ${REGISTRY_PREFIX}/krakend:${VERSION}
          ${REGISTRY_PREFIX}/aiml-postgres:${VERSION}
          ${REGISTRY_PREFIX}/mlflow:${VERSION}
          ${REGISTRY_PREFIX}/crewai:${VERSION}
          ${REGISTRY_PREFIX}/autogen:${VERSION}
          ${REGISTRY_PREFIX}/crewai-studio:${VERSION}
          ${REGISTRY_PREFIX}/autogen-studio:${VERSION}
          ${REGISTRY_PREFIX}/db-migrate:${VERSION}
          ${REGISTRY_PREFIX}/agent-router:${VERSION}
          ${REGISTRY_PREFIX}/platform-manager-api:${VERSION}
          ${REGISTRY_PREFIX}/platform-manager-ui:${VERSION}
          #
          # Pre-built images (14):
          ${REGISTRY_PREFIX}/ollama:${VERSION}
          ${REGISTRY_PREFIX}/ollama-webui:${VERSION}
          ${REGISTRY_PREFIX}/airflow:${VERSION}
          ${REGISTRY_PREFIX}/statsd-exporter:${VERSION}
          ${REGISTRY_PREFIX}/langflow:${VERSION}
          ${REGISTRY_PREFIX}/langfuse:${VERSION}
          ${REGISTRY_PREFIX}/n8n:${VERSION}
          ${REGISTRY_PREFIX}/prometheus:${VERSION}
          ${REGISTRY_PREFIX}/grafana:${VERSION}
          ${REGISTRY_PREFIX}/cadvisor:${VERSION}
          ${REGISTRY_PREFIX}/node-exporter:${VERSION}
          ${REGISTRY_PREFIX}/postgres-exporter:${VERSION}
          ${REGISTRY_PREFIX}/redis-exporter:${VERSION}
          ${REGISTRY_PREFIX}/kube-state-metrics:${VERSION}
          EOF

      - name: Commit manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/image-manifests/
          git commit -m "chore: Add image manifest for ${{ needs.setup.outputs.version }}" || true
          git push || true

  # ===========================================================================
  # Summary — report what was built vs retagged
  # ===========================================================================
  summary:
    name: Build Summary
    needs: [setup, build-changed-images, retag-unchanged-images, mirror-prebuilt-images]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          PREV="${{ needs.setup.outputs.prev_version }}"
          REGISTRY_PREFIX="${{ needs.setup.outputs.registry_prefix }}"
          FORCE="${{ needs.setup.outputs.force_full_build }}"
          WORKFLOW_CHANGED="${{ needs.setup.outputs.workflow_changed }}"

          echo "## Release Build: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Tag | \`${PREV}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Force Full Build | ${FORCE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Changed | ${WORKFLOW_CHANGED} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| build-changed-images | ${{ needs.build-changed-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| retag-unchanged-images | ${{ needs.retag-unchanged-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| mirror-prebuilt-images | ${{ needs.mirror-prebuilt-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### All Images (27)" >> $GITHUB_STEP_SUMMARY
          echo "Registry: \`${REGISTRY_PREFIX}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Custom Images (13):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          for svc in postgres redis krakend aiml-postgres mlflow crewai autogen crewai-studio autogen-studio db-migrate agent-router platform-manager-api platform-manager-ui; do
            echo "${REGISTRY_PREFIX}/${svc}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          done
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-built Images (14):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          for svc in ollama ollama-webui airflow statsd-exporter langflow langfuse n8n prometheus grafana cadvisor node-exporter postgres-exporter redis-exporter kube-state-metrics; do
            echo "${REGISTRY_PREFIX}/${svc}:${VERSION}" >> $GITHUB_STEP_SUMMARY
          done
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installer Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/load-images.sh <customer> ${VERSION} gke" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Check build status
        if: |
          needs.build-changed-images.result == 'failure' ||
          needs.retag-unchanged-images.result == 'failure' ||
          needs.mirror-prebuilt-images.result == 'failure'
        run: |
          echo "::error::Some images failed to build or retag"
          exit 1
