# Credentials & Secrets Management

This document covers how credentials are generated, stored, and rotated across the ES1 Platform.

## Quick Start

```bash
# Generate all credentials for a fresh deployment
./scripts/generate-credentials.sh > .env

# Generate Kubernetes secrets YAML
./scripts/generate-credentials.sh --format=k8s-secrets > secrets.yaml

# Or use the Makefile shortcut
make generate-creds
```

## Installation Checklist

Every deployment — fresh install or upgrade — must complete these steps:

### Step 1: Generate Credentials

```bash
./scripts/generate-credentials.sh > .env
```

This creates cryptographically secure values for all 16 automated secrets. For Kubernetes:

```bash
./scripts/generate-credentials.sh --format=k8s-secrets | kubectl apply -f -
```

### Step 2: Run Database Migrations

```bash
# Docker Compose
docker compose -f docker-compose.yml -f docker-compose.db-migrate.yml run --rm db-migrate python migrate.py --database postgres

# Kubernetes (runs as pre-install Helm hook)
```

The Platform Manager **will not start** if the `audit.api_keys` table is missing.

### Step 3: Start the Platform

```bash
docker compose -f docker-compose.yml -f docker-compose.es1-platform-manager.yml ... up -d
```

### Step 4: Register n8n API Key (Required for n8n Integration)

n8n Community Edition does not support programmatic API key creation. This step **must be completed manually** after every fresh deployment or any upgrade that wipes the n8n database volume.

1. Open the n8n UI at the configured URL (default: `http://localhost:5678`)
2. Log in with the admin credentials from your `.env` (`N8N_DEFAULT_USER_EMAIL` / `N8N_DEFAULT_USER_PASSWORD`)
3. Navigate to **Settings** > **API** > **Create API Key**
4. Copy the generated key
5. Register the key with the Platform Manager:

   **Option A — Via Settings API (no restart needed):**
   ```bash
   curl -X PUT http://localhost:8000/api/v1/settings/n8n_api_key \
     -H "X-API-Key: $DEFAULT_API_KEY" \
     -H "Content-Type: application/json" \
     -d '{"value": "YOUR_N8N_KEY", "category": "credentials", "description": "n8n API key", "is_secret": true}'
   ```

   **Option B — Via environment variable (requires restart):**
   ```bash
   echo "N8N_API_KEY=YOUR_N8N_KEY" >> .env
   docker compose restart es1-platform-manager-api
   ```

   For Kubernetes, update the `n8n-secrets` Secret and restart the Platform Manager pod.

> **Note:** Without this key, the platform functions normally but n8n workflow discovery and execution are unavailable.

### Step 5: Verify

```bash
# Health check
curl http://localhost:8000/api/v1/system/health

# Auth check (when AUTH_MODE=api-key)
curl -H "X-API-Key: $DEFAULT_API_KEY" http://localhost:8000/api/v1/auth/me
```

## Credential Inventory

### Automated (generated by `generate-credentials.sh`)

| Secret | Variable | Method | Used By |
|--------|----------|--------|---------|
| PostgreSQL password | `POSTGRES_PASSWORD` | `openssl rand -base64 24` | All services via DB connections |
| AIML PostgreSQL password | `AIML_POSTGRES_PASSWORD` | `openssl rand -base64 24` | Agent services, knowledge management |
| Platform API key | `DEFAULT_API_KEY` | `pk_<openssl rand -base64 32>` | Platform Manager API, UI login |
| JWT secret | `JWT_SECRET` | `openssl rand -base64 48` | Service-to-service JWT tokens |
| Airflow Fernet key | `AIRFLOW_FERNET_KEY` | Python `cryptography.fernet` or `openssl rand -base64 32` | Airflow connection encryption |
| Airflow webserver secret | `AIRFLOW_WEBSERVER_SECRET` | `openssl rand -base64 32` | Airflow session cookies |
| Airflow admin password | `AIRFLOW_ADMIN_PASSWORD` | `openssl rand -base64 16` | Airflow web UI, Platform Manager basic auth |
| Langfuse NextAuth secret | `LANGFUSE_NEXTAUTH_SECRET` | `openssl rand -base64 32` | Langfuse session management |
| Langfuse salt | `LANGFUSE_SALT` | `openssl rand -base64 32` | Langfuse password hashing |
| Langfuse admin password | `LANGFUSE_INIT_USER_PASSWORD` | `openssl rand -base64 16` | Langfuse admin login |
| Langfuse project public key | `LANGFUSE_INIT_PROJECT_PUBLIC_KEY` | `pk-lf-<openssl rand -hex 16>` | Platform Manager → Langfuse tracing |
| Langfuse project secret key | `LANGFUSE_INIT_PROJECT_SECRET_KEY` | `sk-lf-<openssl rand -hex 16>` | Platform Manager → Langfuse tracing |
| Langflow superuser password | `LANGFLOW_SUPERUSER_PASSWORD` | `openssl rand -base64 16` | Langflow admin login |
| n8n user password | `N8N_DEFAULT_USER_PASSWORD` | `openssl rand -base64 16` | n8n admin login |
| n8n encryption key | `N8N_ENCRYPTION_KEY` | `openssl rand -hex 32` | n8n credential encryption |
| Grafana admin password | `GRAFANA_ADMIN_PASSWORD` | `openssl rand -base64 16` | Grafana admin login |

### Manual (require post-deploy setup)

| Secret | Variable | Setup Location | When Required |
|--------|----------|----------------|---------------|
| n8n API key | `N8N_API_KEY` | n8n Web UI → Settings → API | Fresh install, or any upgrade that wipes n8n volume |

## How Credentials Flow

### Docker Compose

```
generate-credentials.sh → .env file → docker compose reads ${VAR} → injected as container env vars
```

### Kubernetes

```
generate-credentials.sh --format=k8s-secrets → kubectl apply -f → K8s Secret objects → mounted as env vars in pods
```

## Platform API Key Lifecycle

The `DEFAULT_API_KEY` is the bootstrap credential for the Platform Manager API:

1. **Generation:** `generate-credentials.sh` creates a cryptographic key with `pk_` prefix
2. **Startup:** Platform Manager reads `DEFAULT_API_KEY` from environment
3. **Seeding:** `AuthService.initialize()` hashes the key and inserts it into `audit.api_keys` table (if not already present)
4. **Persistence:** The key survives container restarts because it's stored in PostgreSQL
5. **Validation:** All API requests are validated against `audit.api_keys` (with per-pod 60s read-through cache)

### Creating Additional API Keys

```bash
# Via API (requires existing admin key)
curl -X POST http://localhost:8000/api/v1/auth/keys \
  -H "X-API-Key: $DEFAULT_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"name": "CI/CD Pipeline", "permissions": ["gateway.deploy"], "is_admin": false}'
```

### Revoking Keys

```bash
curl -X DELETE http://localhost:8000/api/v1/auth/keys/{key_id} \
  -H "X-API-Key: $DEFAULT_API_KEY"
```

Revoked keys are marked `is_active=false` in the database. The per-pod cache invalidates within 60 seconds across all replicas.

## Upgrade Impact on Credentials

| Scenario | Automated Credentials | n8n API Key | Action Required |
|----------|----------------------|-------------|-----------------|
| **Rolling update** (image change, same volumes) | Preserved in DB | Preserved in n8n DB | None |
| **Config change** (new `.env` values, same volumes) | Preserved — new `DEFAULT_API_KEY` seeded alongside existing keys | Preserved | None unless DB passwords changed |
| **Volume wipe** (fresh deploy) | Re-seeded from `.env` on startup | **LOST** — must re-create | Complete [Step 4](#step-4-register-n8n-api-key-required-for-n8n-integration) |
| **Database password rotation** | Coordinate update across all services | Unaffected | See [Rotating Database Passwords](#rotating-database-passwords) |
| **n8n version upgrade** | Unaffected | Check n8n release notes — key may survive or require re-creation | Verify n8n API access after upgrade |

## Rotation

### Rotating the Platform API Key

1. Generate a new key: `openssl rand -base64 32` → prepend `pk_`
2. Update `DEFAULT_API_KEY` in `.env` or K8s Secret
3. Restart the Platform Manager API — the new key is seeded alongside existing keys
4. Update any external systems using the old key
5. Revoke the old key via the API

### Rotating Database Passwords

Database password rotation requires coordinated restarts:

1. Generate new password
2. Update the PostgreSQL user password: `ALTER USER es1_user WITH PASSWORD 'new_password';`
3. Update `POSTGRES_PASSWORD` in all services that connect to the database
4. Rolling restart all affected services

### Rotating Airflow Fernet Key

The Fernet key encrypts Airflow connection credentials. Rotation requires re-encrypting:

```bash
airflow rotate-fernet-key
```

This must be run inside the Airflow container after updating `AIRFLOW_FERNET_KEY`.

### Rotating the n8n API Key

1. Open n8n UI → Settings → API
2. Revoke the existing key and create a new one
3. Register the new key with Platform Manager (see [Step 4](#step-4-register-n8n-api-key-required-for-n8n-integration))

## Security Notes

- **Never commit `.env` files** — `.gitignore` already excludes them
- **Never commit real K8s secrets** — the template uses `CHANGE_ME` placeholders
- All passwords use cryptographic random generation (not pseudo-random)
- API keys are stored as SHA-256 hashes in the database — the raw key is never persisted
- The `key_prefix` field (first 8 chars) allows identifying keys in logs without exposing them
