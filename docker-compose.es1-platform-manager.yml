# Platform Manager services
# Usage: docker compose -f docker-compose.yml -f docker-compose.es1-platform-manager.yml up -d
#
# Platform Manager provides:
# - Unified management for API Gateway, Workflows, and AI services
# - Resource discovery from Airflow DAGs, Langflow flows, and K8s services
# - Real-time event streaming via SSE
# - Exposure management and approval workflows
# - KrakenD configuration generation and deployment
#
# Access:
# - UI: http://localhost:3001
# - API: http://localhost:8000
# - Health: http://localhost:8000/health
# - API Docs: http://localhost:8000/docs

services:
  platform-manager-api:
    build:
      context: ./services/es1-platform-manager/api
      dockerfile: Dockerfile
    container_name: ${CONTAINER_PREFIX:-engine}-platform-manager-api
    ports:
      - "8000:8000"
    environment:
      # ==========================================================================
      # Runtime Mode (docker or kubernetes)
      # ==========================================================================
      RUNTIME_MODE: docker

      # ==========================================================================
      # Authentication
      # ==========================================================================
      AUTH_MODE: ${AUTH_MODE:-none}
      DEFAULT_API_KEY: ${DEFAULT_API_KEY:-}
      API_KEY_PREFIX: ${API_KEY_PREFIX:-pk}
      JWT_SECRET: ${JWT_SECRET:-}
      CORS_ORIGINS: '${CORS_ORIGINS:-["*"]}'

      # ==========================================================================
      # Database
      # ==========================================================================
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: platform_manager
      POSTGRES_USER: ${POSTGRES_USER:-engine_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-engine_dev_password}

      # ==========================================================================
      # KrakenD Configuration
      # ==========================================================================
      KRAKEND_GATEWAY_NAME: ${KRAKEND_GATEWAY_NAME:-Platform API Gateway}
      KRAKEND_URL: http://${KRAKEND_HOST:-krakend}:${KRAKEND_PORT:-8080}
      KRAKEND_HEALTH_URL: http://${KRAKEND_HOST:-krakend}:${KRAKEND_PORT:-8080}/__health
      KRAKEND_METRICS_URL: http://${KRAKEND_HOST:-krakend}:${KRAKEND_METRICS_PORT:-9091}/metrics
      # Where Platform Manager deploys managed configs (shared volume with KrakenD)
      KRAKEND_CONFIG_PATH: ${KRAKEND_CONFIG_PATH:-/shared/krakend/krakend.json}
      # The original base config (platform service routes, read-only reference)
      KRAKEND_BASE_CONFIG_PATH: ${KRAKEND_BASE_CONFIG_PATH:-/etc/krakend/krakend.json}

      # Kubernetes settings (used when RUNTIME_MODE=kubernetes)
      K8S_NAMESPACE: ${K8S_NAMESPACE:-engine-platform}
      KRAKEND_NAMESPACE: ${KRAKEND_NAMESPACE:-engine-infrastructure}
      KRAKEND_CONFIGMAP_NAME: ${KRAKEND_CONFIGMAP_NAME:-krakend-config}
      KRAKEND_DEPLOYMENT_NAME: ${KRAKEND_DEPLOYMENT_NAME:-krakend}
      # White-label: K8s resource labels and annotation domain
      KRAKEND_MANAGED_BY_LABEL: ${KRAKEND_MANAGED_BY_LABEL:-platform-manager}
      ANNOTATION_DOMAIN: ${ANNOTATION_DOMAIN:-engine.io}

      # ==========================================================================
      # Airflow Integration
      # ==========================================================================
      AIRFLOW_API_URL: http://${AIRFLOW_HOST:-airflow-webserver}:8080/api/v1
      AIRFLOW_BACKEND_HOST: http://${AIRFLOW_HOST:-airflow-webserver}:8080
      AIRFLOW_USERNAME: ${AIRFLOW_ADMIN_USERNAME:-airflow}
      AIRFLOW_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD:-airflow}

      # ==========================================================================
      # Langflow Integration
      # ==========================================================================
      LANGFLOW_URL: http://${LANGFLOW_HOST:-langflow}:7860
      LANGFLOW_API_URL: http://${LANGFLOW_HOST:-langflow}:7860/api/v1
      LANGFLOW_ENABLED: "true"

      # ==========================================================================
      # Langfuse Integration (Observability)
      # These keys must match LANGFUSE_INIT_PROJECT_* in docker-compose.langfuse.yml
      # ==========================================================================
      LANGFUSE_URL: http://${LANGFUSE_HOST:-langfuse}:3000
      LANGFUSE_API_URL: http://${LANGFUSE_HOST:-langfuse}:3000/api
      LANGFUSE_ENABLED: "true"
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_INIT_PROJECT_PUBLIC_KEY:-pk-lf-engine-dev-public-key}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_INIT_PROJECT_SECRET_KEY:-sk-lf-engine-dev-secret-key}

      # ==========================================================================
      # n8n Integration (Automation)
      # ==========================================================================
      N8N_URL: http://${N8N_HOST:-n8n}:5678
      N8N_API_URL: http://${N8N_HOST:-n8n}:5678/api/v1
      N8N_ENABLED: "true"
      # Generate API key in n8n: Settings > API > Create API Key
      N8N_API_KEY: ${N8N_API_KEY:-}

      # ==========================================================================
      # Database API Pattern (for connection exposure)
      # ==========================================================================
      DB_API_HOST_PATTERN: http://db-api-{db_type}:8080

      # ==========================================================================
      # Airflow DAG Management
      # ==========================================================================
      AIRFLOW_DAGS_PATH: /shared/airflow/dags

    volumes:
      # KrakenD config - writable for deployment operations
      - ./services/krakend/config:/etc/krakend
      # Shared volume for KrakenD config deployment (managed mode)
      - krakend_config:/shared/krakend
      # Shared access to Airflow DAGs for DAG editor
      - ./services/airflow/dags:/shared/airflow/dags
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - engine-network

  platform-manager-ui:
    build:
      context: ./services/es1-platform-manager/ui
      dockerfile: Dockerfile
    container_name: ${CONTAINER_PREFIX:-engine}-platform-manager-ui
    ports:
      - "3001:80"
    environment:
      # ==========================================================================
      # Internal service hosts (proxied through nginx)
      # ==========================================================================
      PLATFORM_API_HOST: ${PLATFORM_API_HOST:-platform-manager-api}
      PLATFORM_API_PORT: ${PLATFORM_API_PORT:-8000}
      AGENT_ROUTER_HOST: ${AGENT_ROUTER_HOST:-agent-router}
      AGENT_ROUTER_PORT: ${AGENT_ROUTER_PORT:-8102}

      # ==========================================================================
      # External service URLs (opened in browser)
      # For Docker Compose, these use localhost with exposed ports
      # For Kubernetes, override with Ingress/LoadBalancer URLs
      # ==========================================================================
      GRAFANA_URL: ${GRAFANA_URL:-http://localhost:3002}
      PROMETHEUS_URL: ${PROMETHEUS_URL:-http://localhost:9090}
      LANGFLOW_URL: ${LANGFLOW_URL:-http://localhost:7860}
      MLFLOW_URL: ${MLFLOW_URL:-http://localhost:5050}
      N8N_URL: ${N8N_URL:-http://localhost:5678}
      AIRFLOW_URL: ${AIRFLOW_URL:-http://localhost:8081}
      CREWAI_URL: ${CREWAI_URL:-http://localhost:8100}
      CREWAI_STUDIO_URL: ${CREWAI_STUDIO_URL:-http://localhost:8501}
      AUTOGEN_URL: ${AUTOGEN_URL:-http://localhost:8101}
      LANGFUSE_URL: ${LANGFUSE_URL:-http://localhost:3000}
      OPEN_WEBUI_URL: ${OPEN_WEBUI_URL:-http://localhost:3010}
      AUTOGEN_STUDIO_URL: ${AUTOGEN_STUDIO_URL:-http://localhost:8502}

      # ==========================================================================
      # Branding (configures page title, platform name, etc.)
      # ==========================================================================
      PAGE_TITLE: ${PAGE_TITLE:-Platform}
      PLATFORM_NAME: "${PLATFORM_NAME:-Engine} Platform"
      META_DESCRIPTION: ${META_DESCRIPTION:-Enterprise AI Platform}
      FAVICON_URL: ${FAVICON_URL:-}

      # ==========================================================================
      # Authentication (tells UI whether to show login)
      # ==========================================================================
      AUTH_MODE: ${AUTH_MODE:-none}

      # ==========================================================================
      # Feature flags
      # ==========================================================================
      ENABLE_N8N: "${ENABLE_N8N:-true}"
      ENABLE_LANGFLOW: "${ENABLE_LANGFLOW:-true}"
      ENABLE_CREWAI_STUDIO: "${ENABLE_CREWAI_STUDIO:-true}"
      ENABLE_AUTOGEN_STUDIO: "${ENABLE_AUTOGEN_STUDIO:-true}"
      ENABLE_LANGFUSE: "${ENABLE_LANGFUSE:-true}"
      ENABLE_MLFLOW: "${ENABLE_MLFLOW:-true}"

    depends_on:
      platform-manager-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - engine-network

volumes:
  krakend_config:
    # Shared between platform-manager-api and krakend
    # Platform Manager writes config, KrakenD reads it
