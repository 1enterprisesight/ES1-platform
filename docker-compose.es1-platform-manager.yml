# ES1 Platform Manager services
# Usage: docker compose -f docker-compose.yml -f docker-compose.es1-platform-manager.yml up -d
#
# ES1 Platform Manager provides:
# - Unified management for API Gateway, Workflows, and AI services
# - Resource discovery from Airflow DAGs, Langflow flows, and K8s services
# - Real-time event streaming via SSE
# - Exposure management and approval workflows
# - KrakenD configuration generation and deployment
#
# Access:
# - UI: http://localhost:3001
# - API: http://localhost:8000
# - Health: http://localhost:8000/health
# - API Docs: http://localhost:8000/docs

services:
  es1-platform-manager-api:
    build:
      context: ./services/es1-platform-manager/api
      dockerfile: Dockerfile
    container_name: es1-platform-manager-api
    ports:
      - "8000:8000"
    environment:
      # ==========================================================================
      # Runtime Mode (docker or kubernetes)
      # ==========================================================================
      RUNTIME_MODE: docker

      # ==========================================================================
      # Database
      # ==========================================================================
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: platform_manager
      POSTGRES_USER: es1_user
      POSTGRES_PASSWORD: es1_dev_password

      # ==========================================================================
      # KrakenD Configuration
      # ==========================================================================
      KRAKEND_URL: http://krakend:8080
      KRAKEND_HEALTH_URL: http://krakend:8080/__health
      KRAKEND_METRICS_URL: http://krakend:9091/metrics
      # In dev mode, read from the mounted host directory
      # In prod mode, this would be /shared/krakend/krakend.json (managed volume)
      KRAKEND_CONFIG_PATH: /etc/krakend/krakend.json

      # Kubernetes settings (used when RUNTIME_MODE=kubernetes)
      K8S_NAMESPACE: es1-platform
      KRAKEND_NAMESPACE: es1-infrastructure
      KRAKEND_CONFIGMAP_NAME: krakend-config
      KRAKEND_DEPLOYMENT_NAME: krakend

      # ==========================================================================
      # Airflow Integration
      # ==========================================================================
      AIRFLOW_API_URL: http://airflow-webserver:8080/api/v1
      AIRFLOW_BACKEND_HOST: http://airflow-webserver:8080
      AIRFLOW_USERNAME: airflow
      AIRFLOW_PASSWORD: airflow

      # ==========================================================================
      # Langflow Integration
      # ==========================================================================
      LANGFLOW_URL: http://langflow:7860
      LANGFLOW_API_URL: http://langflow:7860/api/v1
      LANGFLOW_ENABLED: "true"

      # ==========================================================================
      # Langfuse Integration (Observability)
      # ==========================================================================
      LANGFUSE_URL: http://langfuse:3000
      LANGFUSE_API_URL: http://langfuse:3000/api
      LANGFUSE_ENABLED: "true"
      LANGFUSE_PUBLIC_KEY: "pk-lf-613401d7-ffd4-40e0-9386-644f24731ee9"
      LANGFUSE_SECRET_KEY: "sk-lf-32cde39e-0b9e-4c74-8686-3e91d8b57e1e"

      # ==========================================================================
      # n8n Integration (Automation)
      # ==========================================================================
      N8N_URL: http://n8n:5678
      N8N_API_URL: http://n8n:5678/api/v1
      N8N_ENABLED: "true"
      # Generate API key in n8n: Settings > API > Create API Key
      N8N_API_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI5YmIyODQxMS0xZGZjLTQ5NTktYjkwZS1hMmVkMzRmY2RjZTciLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzY5MzgzODEyfQ.PDHzYdnHDjORTLpfgB1VLC5IexNAReNY5cYVZSdRgzs"

      # ==========================================================================
      # Database API Pattern (for connection exposure)
      # ==========================================================================
      DB_API_HOST_PATTERN: http://db-api-{db_type}:8080

      # ==========================================================================
      # Airflow DAG Management
      # ==========================================================================
      AIRFLOW_DAGS_PATH: /shared/airflow/dags

    volumes:
      # KrakenD config - writable for deployment operations
      - ./services/krakend/config:/etc/krakend
      # Shared volume for KrakenD config deployment (managed mode)
      - krakend_config:/shared/krakend
      # Shared access to Airflow DAGs for DAG editor
      - ./services/airflow/dags:/shared/airflow/dags
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - es1-network

  es1-platform-manager-ui:
    build:
      context: ./services/es1-platform-manager/ui
      dockerfile: Dockerfile
    container_name: es1-platform-manager-ui
    ports:
      - "3001:80"
    environment:
      # ==========================================================================
      # Internal service hosts (proxied through nginx)
      # ==========================================================================
      PLATFORM_API_HOST: es1-platform-manager-api
      PLATFORM_API_PORT: "8000"
      AGENT_ROUTER_HOST: agent-router
      AGENT_ROUTER_PORT: "8102"

      # ==========================================================================
      # External service URLs (opened in browser)
      # For Docker Compose, these use localhost with exposed ports
      # For Kubernetes, override with Ingress/LoadBalancer URLs
      # ==========================================================================
      GRAFANA_URL: http://localhost:3002
      PROMETHEUS_URL: http://localhost:9090
      LANGFLOW_URL: http://localhost:7860
      MLFLOW_URL: http://localhost:5050
      N8N_URL: http://localhost:5678
      AIRFLOW_URL: http://localhost:8081
      CREWAI_URL: http://localhost:8100
      CREWAI_STUDIO_URL: http://localhost:8501
      AUTOGEN_URL: http://localhost:8101
      LANGFUSE_URL: http://localhost:3003
      OPEN_WEBUI_URL: http://localhost:3000

      # ==========================================================================
      # Feature flags
      # ==========================================================================
      ENABLE_N8N: "true"
      ENABLE_LANGFLOW: "true"
      ENABLE_CREWAI_STUDIO: "true"
      ENABLE_LANGFUSE: "true"
      ENABLE_MLFLOW: "true"

    depends_on:
      es1-platform-manager-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - es1-network

volumes:
  krakend_config:
    # Shared between es1-platform-manager-api and krakend
    # Platform Manager writes config, KrakenD reads it
